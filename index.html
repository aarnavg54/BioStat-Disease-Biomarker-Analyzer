<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BioStat | Patient Level Data Analysis</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-blue: #1a365d;
            --secondary-blue: #2c5282;
            --accent-blue: #4299e1;
            --light-blue: #bee3f8;
            --medical-teal: #38b2ac;
            --medical-green: #48bb78;
            --medical-red: #f56565;
            --medical-yellow: #ecc94b;
            --medical-purple: #9f7aea;
            --bg-light: #f7fafc;
            --card-bg: #ffffff;
            --text-dark: #2d3748;
            --text-light: #718096;
            --border-color: #e2e8f0;
        }
        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f0 100%);
            color: var(--text-dark);
            line-height: 1.6;
        }
        header {
            background: linear-gradient(135deg, #67b26f 0%, #4ca2cd 100%);
            color: white;
            padding: 20px 30px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            position: relative;
            z-index: 1;
        }
        .header-icon {
            font-size: 36px;
            color: var(--light-blue);
            animation: pulse 3s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        .header-text h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .header-text p {
            margin: 8px 0 0;
            font-size: 16px;
            opacity: 0.9;
            font-weight: 300;
        }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .layout {
            display: flex;
            gap: 25px;
            align-items: flex-start;
        }
        .sidebar {
            width: 350px;
            flex-shrink: 0;
        }
        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 22px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }
        .section-title {
            font-size: 20px;
            font-weight: 600;
            border-bottom: 3px solid var(--medical-teal);
            padding-bottom: 10px;
            margin-bottom: 18px;
            color: var(--primary-blue);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .section-title i {
            color: var(--accent-blue);
        }
        .variable-list {
            max-height: 350px;
            overflow-y: auto;
            padding-right: 8px;
        }
        .variable-list::-webkit-scrollbar {
            width: 8px;
        }
        .variable-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        .variable-list::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 4px;
        }
        .variable-item {
            padding: 14px 16px;
            margin-bottom: 10px;
            background: #f8fafc;
            border-left: 5px solid var(--accent-blue);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .variable-item:hover {
            background: #edf2f7;
            transform: translateX(5px);
            box-shadow: 0 3px 8px rgba(66, 153, 225, 0.1);
        }
        .variable-item.selected {
            background: linear-gradient(135deg, #e6fffa 0%, #f0fff4 100%);
            border-left-color: var(--medical-green);
            border: 1px solid var(--medical-green);
            box-shadow: 0 3px 10px rgba(72, 187, 120, 0.15);
        }
        .variable-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        .variable-item i {
            color: var(--secondary-blue);
            font-size: 16px;
        }
        .variable-item.selected i {
            color: var(--medical-green);
        }
        .variable-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--medical-green);
        }
        .comparison-mode-toggle {
            background: linear-gradient(135deg, var(--medical-purple) 0%, #805ad5 100%);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            width: 100%;
            justify-content: center;
            font-weight: 600;
        }
        .comparison-mode-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(159, 122, 234, 0.3);
        }
        .comparison-mode-toggle.active {
            background: linear-gradient(135deg, var(--medical-green) 0%, #38a169 100%);
        }
        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            letter-spacing: 0.3px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0, 0, 0, 0.15);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn.primary {
            background: linear-gradient(135deg, var(--accent-blue) 0%, var(--secondary-blue) 100%);
            color: white;
        }
        .btn.secondary {
            background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
            color: white;
        }
        .btn.success {
            background: linear-gradient(135deg, var(--medical-green) 0%, #38a169 100%);
            color: white;
        }
        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-top: 5px solid var(--accent-blue);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.08);
        }
        .stat-card strong {
            display: block;
            font-size: 24px;
            margin-top: 10px;
            color: var(--primary-blue);
        }
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            position: relative;
        }
        canvas {
            max-height: 350px;
            width: 100% !important;
        }
        .file-upload {
            position: relative;
            padding: 25px;
            border: 2px dashed var(--accent-blue);
            border-radius: 10px;
            text-align: center;
            background: #f0f9ff;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        .file-upload:hover {
            background: #e6f7ff;
            border-color: var(--secondary-blue);
        }
        .file-upload input {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-upload i {
            font-size: 40px;
            color: var(--accent-blue);
            margin-bottom: 15px;
        }
        .file-upload p {
            margin: 0;
            font-weight: 500;
            color: var(--secondary-blue);
        }
        .status-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 5px solid var(--medical-green);
            font-weight: 500;
            margin-top: 15px;
        }
        .status-box.loading {
            border-left-color: var(--accent-blue);
        }
        .status-box.error {
            border-left-color: var(--medical-red);
        }
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 15px;
        }
        .action-buttons .btn {
            flex: 1;
            margin-top: 0;
        }

        /* NEW: Search Bar Styles */
        .search-container {
            margin: 15px 0;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-blue);
            cursor: pointer;
        }
        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .search-result-item {
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid #f1f1f1;
        }
        .search-result-item:hover {
            background: #f7fafc;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }

        /* NEW: Patient Data Point Viewer */
        .patient-data-viewer {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid var(--medical-purple);
        }
        .patient-search-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .patient-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
        }
        .patient-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .patient-result {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .patient-result h4 {
            margin: 0 0 10px 0;
            color: var(--primary-blue);
        }
        .patient-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--medical-green);
            margin: 10px 0;
        }

        /* NEW: Export Icon Styles */
        .export-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
        }
        .export-btn:hover {
            background: var(--secondary-blue);
            transform: scale(1.1);
        }
        .chart-container .export-btn {
            top: 15px;
            right: 15px;
        }
        .stat-card .export-btn {
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            font-size: 14px;
        }
        .risk-gauge-container .export-btn {
            top: 25px;
            right: 25px;
        }
        .insights-panel .export-btn {
            top: 20px;
            right: 20px;
        }
        .correlation-info .export-btn {
            top: 20px;
            right: 20px;
        }

        /* Insights Panel Styles */
        .insights-panel {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
            border-left: 5px solid var(--accent-blue);
            animation: slideIn 0.5s ease;
            position: relative;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .insights-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .insight-item {
            background: white;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: start;
            gap: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.3s ease;
        }
        .insight-icon {
            font-size: 20px;
            margin-top: 2px;
        }
        .insight-text {
            flex: 1;
        }
        .insight-label {
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 3px;
        }
        .insight-description {
            color: var(--text-light);
            font-size: 14px;
        }
        .tooltip-icon {
            color: var(--accent-blue);
            cursor: help;
            font-size: 14px;
            margin-left: 5px;
        }

        /* Risk Score Gauge */
        .risk-gauge-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            text-align: center;
            position: relative;
        }
        .gauge-wrapper {
            position: relative;
            width: 250px;
            height: 150px;
            margin: 20px auto;
        }
        .gauge-background {
            width: 250px;
            height: 125px;
            background: linear-gradient(90deg, 
                var(--medical-green) 0%, 
                var(--medical-yellow) 50%, 
                var(--medical-red) 100%);
            border-radius: 125px 125px 0 0;
            position: relative;
            overflow: hidden;
        }
        .gauge-mask {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 100px;
            background: white;
            border-radius: 100px 100px 0 0;
        }
        .gauge-needle {
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 4px;
            height: 100px;
            background: var(--text-dark);
            transform-origin: bottom center;
            transform: translateX(-50%) rotate(-90deg);
            transition: transform 1s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 10;
        }
        .gauge-center {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: var(--text-dark);
            border-radius: 50%;
            z-index: 11;
        }
        .gauge-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-blue);
            margin-top: 10px;
        }
        .gauge-label {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }
        .risk-level {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            margin-top: 15px;
            animation: pulse 2s infinite;
        }
        .risk-level.low {
            background: #c6f6d5;
            color: #22543d;
        }
        .risk-level.moderate {
            background: #fef5e7;
            color: #975a16;
        }
        .risk-level.high {
            background: #fed7d7;
            color: #742a2a;
        }
        .risk-disclaimer {
            background: #fff5f5;
            border: 1px solid #feb2b2;
            border-radius: 8px;
            padding: 12px;
            margin-top: 20px;
            font-size: 13px;
            color: #742a2a;
            text-align: left;
        }
        .contributing-factors {
            margin-top: 25px;
            text-align: left;
        }
        .factor-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 8px;
        }
        .factor-bar-container {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .factor-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-blue), var(--secondary-blue));
            border-radius: 4px;
            transition: width 1s ease;
        }

        /* Comparison View Styles */
        .comparison-charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 25px;
        }
        .correlation-info {
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid var(--medical-purple);
            position: relative;
        }
        .correlation-strength {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-blue);
            margin: 10px 0;
        }
        .correlation-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 15px;
            font-weight: 600;
            font-size: 14px;
            margin-top: 10px;
        }
        .correlation-badge.weak {
            background: #e2e8f0;
            color: #4a5568;
        }
        .correlation-badge.moderate {
            background: #fef5e7;
            color: #975a16;
        }
        .correlation-badge.strong {
            background: #c6f6d5;
            color: #22543d;
        }

        @media (max-width: 900px) {
            .layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
            }
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .comparison-charts-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .header-text h1 {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-dna"></i>
            </div>
            <div class="header-text">
                <h1>BioStat | Patient Level Data Analysis</h1>
                <p>Interactive statistical analysis with intelligent insights</p>
            </div>
        </div>
    </header>
    <div class="container">
        <div class="layout">
            <!-- Sidebar -->
            <div class="sidebar">
                <div class="panel">
                    <h2 class="section-title"><i class="fas fa-database"></i> Dataset</h2>
                    <div class="file-upload">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Click to upload CSV file</p>
                        <input type="file" id="csvInput" accept=".csv">
                    </div>
                    <div id="statusText" class="status-box">No dataset loaded</div>
                </div>
                <div class="panel">
                    <h2 class="section-title"><i class="fas fa-microscope"></i> Variables</h2>
                    <button id="comparisonModeBtn" class="comparison-mode-toggle">
                        <i class="fas fa-exchange-alt"></i>
                        <span>Enable Comparison Mode</span>
                    </button>
                    
                    <!-- NEW: Search Bar -->
                    <div class="search-container">
                        <input type="text" id="biomarkerSearch" class="search-input" placeholder="Search for a variable...">
                        <i class="fas fa-search search-icon"></i>
                        <div id="searchResults" class="search-results"></div>
                    </div>
                    
                    <div id="biomarkerList" class="variable-list"></div>
                    <div class="action-buttons">
                        <button id="analyzeBtn" class="btn primary" disabled>
                            <i class="fas fa-chart-bar"></i> Analyze
                        </button>
                        <button id="summaryBtn" class="btn secondary" disabled>
                            <i class="fas fa-clipboard-list"></i> Summary
                        </button>
                    </div>
                    <button id="riskScoreBtn" class="btn success" disabled style="margin-top: 15px;">
                        <i class="fas fa-heartbeat"></i> Calculate Risk Score
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div style="flex:1">
                <div id="welcomeView" class="panel view active">
                    <h2 class="section-title"><i class="fas fa-heartbeat"></i> Welcome to BioStat</h2>
                    <p>BioStat is an interactive data analysis platform for patient level healthcare data. It helps users explore relationships between variables, visualize distributions, and generate intuitive summary indicators from complex datasets.</p>
                    
                    <div class="stats-grid" style="margin-top: 30px;">
                        <div class="stat-card">
                            <i class="fas fa-exchange-alt" style="font-size: 24px; color: var(--medical-purple);"></i>
                            <div>Interactive Comparison</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-brain" style="font-size: 24px; color: var(--medical-teal);"></i>
                            <div>Intelligent Insights</div>
                        </div>
                        <div class="stat-card">
                            <i class="fas fa-gauge-high" style="font-size: 24px; color: var(--medical-green);"></i>
                            <div>Risk Scoring</div>
                        </div>
                    </div>

                    <div style="margin-top: 30px; padding: 20px; background: #f0f9ff; border-radius: 10px; border-left: 5px solid var(--accent-blue);">
                        <h3 style="margin-top: 0; color: var(--primary-blue);">
                            <i class="fas fa-rocket"></i> Quick Start Guide
                        </h3>
                        <ol style="color: var(--text-dark); line-height: 1.8;">
                            <li><strong>Upload your CSV dataset</strong> containing patient level health or clinical variables</li>
                            <li><strong>Single Analysis:</strong> Select any variable to view its distribution, summary statistics, and visual insights</li>
                            <li><strong>Comparison Mode:</strong> Enable comparison mode and select 2-3 variables to explore correlations</li>
                            <li><strong>Risk Scoring:</strong> Select multiple variables and calculate a composite health indicator</li>
                            <li><strong>Search:</strong> Use the search bar to quickly find specific variables</li>
                        </ol>
                    </div>
                </div>

                <div id="analysisView" class="view">
                    <div class="panel">
                        <h2 id="analysisTitle" class="section-title"></h2>
                        <p id="analysisSubtitle"></p>
                        <div id="statsGrid" class="stats-grid"></div>
                        
                        <!-- NEW: Patient Data Point Viewer -->
                        <div id="patientDataViewer" class="patient-data-viewer" style="display: none;">
                            <h3 style="margin-top: 0; color: var(--primary-blue);">
                                <i class="fas fa-user-md"></i> Patient Data Point Lookup
                            </h3>
                            <div class="patient-search-form">
                                <input type="number" id="patientNumber" class="patient-input" placeholder="Enter patient number (1 to max)" min="1" step="1">
                                <button id="lookupPatientBtn" class="btn primary" style="width: auto; padding: 12px 20px;">
                                    <i class="fas fa-search"></i> Lookup
                                </button>
                            </div>
                            <div id="patientResult" class="patient-result" style="display: none;">
                                <h4>Patient <span id="patientIdDisplay"></span></h4>
                                <div>Variable: <strong id="patientBiomarkerName"></strong></div>
                                <div class="patient-value" id="patientValueDisplay"></div>
                                <div style="color: var(--text-light); font-size: 14px;">
                                    Position: <span id="patientPosition"></span> in the distribution
                                </div>
                            </div>
                        </div>

                        <!-- Insights Panel -->
                        <div id="insightsPanel" class="insights-panel">
                            <button class="export-btn" title="Export Insights" onclick="exportComponent('insights', '${selected}_insights')">
                                <i class="fas fa-download"></i>
                            </button>
                            <div class="insights-title">
                                <i class="fas fa-lightbulb"></i>
                                Data Insights
                            </div>
                            <div id="insightsList"></div>
                        </div>

                        <div class="chart-container">
                            <button class="export-btn" title="Export Chart" onclick="exportComponent('chart', '${selected}_distribution_chart')">
                                <i class="fas fa-download"></i>
                            </button>
                            <h3 style="margin-top: 0; color: var(--primary-blue);">
                                <i class="fas fa-chart-line"></i> Distribution Chart
                            </h3>
                            <canvas id="distChart"></canvas>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 25px;">
                            <button id="saveBtn" class="btn success">
                                <i class="fas fa-file-export"></i> Export Full Report
                            </button>
                            <button class="btn secondary" onclick="showView('welcomeView')">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Comparison View -->
                <div id="comparisonView" class="view">
                    <div class="panel">
                        <h2 class="section-title">
                            <i class="fas fa-exchange-alt"></i> Variable Comparison
                        </h2>
                        <p id="comparisonSubtitle"></p>
                        
                        <div class="comparison-charts-grid">
                            <div class="chart-container">
                                <button class="export-btn" title="Export Bar Chart" onclick="exportComponent('comparisonBarChart', 'biomarker_comparison_bar_chart')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <h3 style="margin-top: 0; color: var(--primary-blue);">
                                    <i class="fas fa-chart-bar"></i> Distribution Comparison
                                </h3>
                                <canvas id="comparisonBarChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <button class="export-btn" title="Export Scatter Plot" onclick="exportComponent('scatterChart', 'correlation_scatter_plot')">
                                    <i class="fas fa-download"></i>
                                </button>
                                <h3 style="margin-top: 0; color: var(--primary-blue);">
                                    <i class="fas fa-chart-scatter"></i> Correlation Analysis
                                </h3>
                                <canvas id="scatterChart"></canvas>
                            </div>
                        </div>

                        <div id="correlationInfo" class="correlation-info">
                            <button class="export-btn" title="Export Correlation Info" onclick="exportComponent('correlationInfo', 'correlation_analysis')">
                                <i class="fas fa-download"></i>
                            </button>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                <i class="fas fa-project-diagram" style="font-size: 24px; color: var(--medical-purple);"></i>
                                <h3 style="margin: 0;">Correlation Strength</h3>
                            </div>
                            <div id="correlationValue" class="correlation-strength">r = 0.00</div>
                            <div id="correlationBadge" class="correlation-badge weak">Weak Correlation</div>
                            <p style="margin-top: 15px; color: var(--text-light); font-size: 14px;">
                                <i class="fas fa-info-circle"></i> 
                                Correlation measures the strength of the linear relationship between two variables.
                            </p>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 25px;">
                            <button class="btn secondary" onclick="showView('welcomeView')">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Risk Score View -->
                <div id="riskScoreView" class="view">
                    <div class="panel">
                        <h2 class="section-title">
                            <i class="fas fa-heartbeat"></i> Composite Health Indicator
                        </h2>
                        <p id="riskSubtitle"></p>

                        <div class="risk-gauge-container">
                            <button class="export-btn" title="Export Risk Gauge" onclick="exportComponent('riskGauge', 'risk_assessment_gauge')">
                                <i class="fas fa-download"></i>
                            </button>
                            <h3 style="margin: 0; color: var(--primary-blue);">Risk Assessment Score</h3>
                            <div class="gauge-wrapper">
                                <div class="gauge-background">
                                    <div class="gauge-mask"></div>
                                </div>
                                <div id="gaugeNeedle" class="gauge-needle"></div>
                                <div class="gauge-center"></div>
                            </div>
                            <div id="gaugeValue" class="gauge-value">0</div>
                            <div class="gauge-label">Composite Score (0-100)</div>
                            <div id="riskLevel" class="risk-level low">Low Risk</div>

                            <div class="risk-disclaimer">
                                <strong><i class="fas fa-exclamation-triangle"></i> Important Disclaimer:</strong><br>
                                This is a prototype educational model for demonstration purposes only. This score is not a medical diagnosis and should not be used for clinical decision-making.
                            </div>
                        </div>

                        <div class="contributing-factors">
                            <h3 style="color: var(--primary-blue); margin-bottom: 15px;">
                                <i class="fas fa-list-check"></i> Contributing Factors
                            </h3>
                            <div id="factorsList"></div>
                        </div>

                        <div style="display: flex; gap: 15px; margin-top: 25px;">
                            <button class="btn secondary" onclick="showView('welcomeView')">
                                <i class="fas fa-arrow-left"></i> Back to Dashboard
                            </button>
                        </div>
                    </div>
                </div>

                <div id="summaryView" class="view">
                    <div class="panel">
                        <h2 class="section-title"><i class="fas fa-clipboard-check"></i> Dataset Summary</h2>
                        <div id="summaryStats" class="stats-grid"></div>
                        <div style="margin-top: 30px;">
                            <button class="btn secondary" onclick="showView('welcomeView')">
                                <i class="fas fa-arrow-left"></i> Back
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dataset = [];
        let variables = [];
        let selected = null;
        let chart = null;
        let comparisonMode = false;
        let selectedBiomarkers = [];
        let currentValues = []; // Store current variable values for patient lookup

        /* ---------- CSV LOADING ---------- */
        document.getElementById("csvInput").addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            const statusBox = document.getElementById("statusText");
            statusBox.textContent = "Loading dataset...";
            statusBox.className = "status-box loading";
            const reader = new FileReader();
            reader.onload = () => parseCSV(reader.result);
            reader.readAsText(file);
        });

        function parseCSV(text) {
            try {
                const rows = text.trim().split("\n").map(r => r.split(","));
                const headers = rows[0];
                variables = headers.slice(1);
                dataset = rows.slice(1).map(r => {
                    const obj = {};
                    variables.forEach((b,i) => obj[b] = parseFloat(r[i+1]));
                    return obj;
                });

                const statusBox = document.getElementById("statusText");
                statusBox.innerHTML = `<i class="fas fa-check-circle" style="color: var(--medical-green);"></i> Loaded <strong>${dataset.length}</strong> patients with <strong>${variables.length}</strong> variables`;
                statusBox.className = "status-box";

                document.getElementById("analyzeBtn").disabled = false;
                document.getElementById("summaryBtn").disabled = false;
                document.getElementById("riskScoreBtn").disabled = false;
                renderBiomarkers();
            } catch (error) {
                document.getElementById("statusText").textContent = "Error loading CSV file. Please check the format.";
                document.getElementById("statusText").className = "status-box error";
            }
        }

        /* ---------- SEARCH FUNCTIONALITY ---------- */
        document.getElementById("biomarkerSearch").addEventListener("input", function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById("searchResults");
            
            if (searchTerm.length < 1) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const filteredBiomarkers = variables.filter(b => 
                b.toLowerCase().includes(searchTerm)
            );
            
            if (filteredBiomarkers.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No variables found</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            resultsContainer.innerHTML = '';
            filteredBiomarkers.forEach(b => {
                const item = document.createElement("div");
                item.className = "search-result-item";
                item.innerHTML = `<i class="fas fa-dna" style="margin-right: 8px;"></i>${b}`;
                item.onclick = () => {
                    document.getElementById("biomarkerSearch").value = b;
                    resultsContainer.style.display = 'none';
                    
                    // Find and select the variable in the list
                    const biomarkerItems = document.querySelectorAll('.variable-item');
                    biomarkerItems.forEach(item => {
                        if (item.textContent.includes(b)) {
                            if (comparisonMode) {
                                const checkbox = item.querySelector('.variable-checkbox');
                                if (checkbox && !checkbox.checked) {
                                    checkbox.checked = true;
                                    toggleBiomarkerSelection(b, true);
                                }
                            } else {
                                selectBiomarker(b, item);
                            }
                            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    });
                };
                resultsContainer.appendChild(item);
            });
            
            resultsContainer.style.display = 'block';
        });

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!document.getElementById("biomarkerSearch").contains(e.target) && 
                !document.getElementById("searchResults").contains(e.target)) {
                document.getElementById("searchResults").style.display = 'none';
            }
        });

        /* ---------- UI ---------- */
        function renderBiomarkers() {
            const list = document.getElementById("biomarkerList");
            list.innerHTML = "";
            variables.forEach(b => {
                const div = document.createElement("div");
                div.className = "variable-item";
                
                if (comparisonMode) {
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.className = "variable-checkbox";
                    checkbox.checked = selectedBiomarkers.includes(b);
                    checkbox.onchange = (e) => {
                        e.stopPropagation();
                        toggleBiomarkerSelection(b, checkbox.checked);
                    };
                    
                    const content = document.createElement("div");
                    content.className = "variable-item-content";
                    content.innerHTML = `<i class="fas fa-dna"></i> ${b}`;
                    
                    div.appendChild(checkbox);
                    div.appendChild(content);
                    div.onclick = () => {
                        checkbox.checked = !checkbox.checked;
                        toggleBiomarkerSelection(b, checkbox.checked);
                    };
                } else {
                    div.innerHTML = `
                        <div class="variable-item-content">
                            <i class="fas fa-dna"></i> ${b}
                        </div>
                    `;
                    div.onclick = () => selectBiomarker(b, div);
                }
                
                if (selectedBiomarkers.includes(b)) {
                    div.classList.add("selected");
                }
                
                list.appendChild(div);
            });
        }

        function toggleBiomarkerSelection(b, isChecked) {
            if (isChecked) {
                if (selectedBiomarkers.length < 3) {
                    selectedBiomarkers.push(b);
                } else {
                    alert("You can select up to 3 variables for comparison");
                    renderBiomarkers();
                    return;
                }
            } else {
                selectedBiomarkers = selectedBiomarkers.filter(x => x !== b);
            }
            renderBiomarkers();
        }

        function selectBiomarker(b, el) {
            document.querySelectorAll(".variable-item").forEach(i => i.classList.remove("selected"));
            el.classList.add("selected");
            selected = b;
        }

        /* ---------- COMPARISON MODE ---------- */
        document.getElementById("comparisonModeBtn").onclick = () => {
            comparisonMode = !comparisonMode;
            selectedBiomarkers = [];
            const btn = document.getElementById("comparisonModeBtn");
            const analyzeBtn = document.getElementById("analyzeBtn");
            
            if (comparisonMode) {
                btn.classList.add("active");
                btn.innerHTML = '<i class="fas fa-check"></i><span>Comparison Mode Active</span>';
                analyzeBtn.innerHTML = '<i class="fas fa-exchange-alt"></i> Compare Selected';
            } else {
                btn.classList.remove("active");
                btn.innerHTML = '<i class="fas fa-exchange-alt"></i><span>Enable Comparison Mode</span>';
                analyzeBtn.innerHTML = '<i class="fas fa-chart-bar"></i> Analyze';
            }
            
            renderBiomarkers();
        };

        /* ---------- STATS ---------- */
        function stats(values) {
            const n = values.length;
            const mean = values.reduce((a,b) => a + b, 0) / n;
            const sorted = [...values].sort((a,b) => a - b);
            const median = sorted[Math.floor(n/2)];
            const q1 = sorted[Math.floor(n * 0.25)];
            const q3 = sorted[Math.floor(n * 0.75)];
            const variance = values.reduce((s, v) => s + (v - mean) ** 2, 0) / n;
            const sd = Math.sqrt(variance);
            const cv = sd / mean;
            const skew = (mean - median) / sd;
            const iqr = q3 - q1;
            const outliers = values.filter(v => v < q1 - 1.5 * iqr || v > q3 + 1.5 * iqr).length;
            const range = sorted[n-1] - sorted[0];
            
            return { 
                mean, median, q1, q3, variance, sd, cv, skew, iqr, outliers, 
                min: sorted[0], max: sorted[n-1], count: n, range
            };
        }

        function calculateCorrelation(values1, values2) {
            const n = values1.length;
            const mean1 = values1.reduce((a,b) => a + b, 0) / n;
            const mean2 = values2.reduce((a,b) => a + b, 0) / n;
            
            let numerator = 0;
            let denom1 = 0;
            let denom2 = 0;
            
            for (let i = 0; i < n; i++) {
                const diff1 = values1[i] - mean1;
                const diff2 = values2[i] - mean2;
                numerator += diff1 * diff2;
                denom1 += diff1 * diff1;
                denom2 += diff2 * diff2;
            }
            
            return numerator / Math.sqrt(denom1 * denom2);
        }

        /* ---------- PATIENT DATA LOOKUP ---------- */
        document.getElementById("lookupPatientBtn").onclick = function() {
            const patientNum = parseInt(document.getElementById("patientNumber").value);
            const maxPatients = dataset.length;
            
            if (!selected) {
                alert("Please select a variable first");
                return;
            }
            
            if (isNaN(patientNum) || patientNum < 1 || patientNum > maxPatients) {
                alert(`Please enter a valid patient number between 1 and ${maxPatients}`);
                return;
            }
            
            const value = dataset[patientNum - 1][selected];
            const sortedValues = [...currentValues].sort((a, b) => a - b);
            const position = sortedValues.findIndex(v => v === value) + 1;
            
            document.getElementById("patientResult").style.display = 'block';
            document.getElementById("patientIdDisplay").textContent = patientNum;
            document.getElementById("patientBiomarkerName").textContent = selected;
            document.getElementById("patientValueDisplay").textContent = value.toFixed(3);
            document.getElementById("patientPosition").textContent = `${position} of ${maxPatients}`;
        };

        /* ---------- EXPORT FUNCTIONALITY ---------- */
        function exportComponent(componentType, filename) {
            if (componentType === 'chart') {
                // Export chart as PNG
                const chartCanvas = document.getElementById('distChart');
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = chartCanvas.toDataURL('image/png');
                link.click();
            } 
            else if (componentType === 'comparisonBarChart') {
                const chartCanvas = document.getElementById('comparisonBarChart');
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = chartCanvas.toDataURL('image/png');
                link.click();
            }
            else if (componentType === 'scatterChart') {
                const chartCanvas = document.getElementById('scatterChart');
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = chartCanvas.toDataURL('image/png');
                link.click();
            }
            else if (componentType === 'riskGauge') {
                // Export risk gauge as PNG
                const gaugeContainer = document.querySelector('.risk-gauge-container');
                html2canvas(gaugeContainer).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${filename}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            }
            else if (componentType === 'insights') {
                // Export insights as text
                const insights = document.querySelectorAll('#insightsList .insight-item');
                let text = `BIOSTAT INSIGHTS REPORT\n`;
                text += `============================================\n\n`;
                text += `Variable: ${selected}\n`;
                text += `Generated: ${new Date().toLocaleString()}\n\n`;
                
                insights.forEach(insight => {
                    const label = insight.querySelector('.insight-label').textContent.replace(/\s+/g, ' ').trim();
                    const desc = insight.querySelector('.insight-description').textContent;
                    text += `${label}: ${desc}\n\n`;
                });
                
                const blob = new Blob([text], {type: "text/plain"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `${filename}.txt`;
                a.click();
            }
            else if (componentType === 'correlationInfo') {
                // Export correlation info as text
                const correlationValue = document.getElementById('correlationValue').textContent;
                const correlationBadge = document.getElementById('correlationBadge').textContent;
                
                let text = `BIOSTAT CORRELATION ANALYSIS\n`;
                text += `============================================\n\n`;
                text += `Variables: ${selectedBiomarkers.join(' vs ')}\n`;
                text += `Correlation: ${correlationValue}\n`;
                text += `Strength: ${correlationBadge}\n`;
                text += `Generated: ${new Date().toLocaleString()}\n`;
                
                const blob = new Blob([text], {type: "text/plain"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `${filename}.txt`;
                a.click();
            }
            else {
                // Default: export stats as text
                const statCards = document.querySelectorAll('#statsGrid .stat-card');
                let text = `BIOSTAT STATISTICAL REPORT\n`;
                text += `============================================\n\n`;
                text += `Variable: ${selected}\n`;
                text += `Generated: ${new Date().toLocaleString()}\n\n`;
                
                statCards.forEach(card => {
                    const lines = card.textContent.split('\n');
                    if (lines.length >= 2) {
                        text += `${lines[0].trim()}: ${lines[2].trim()}\n`;
                    }
                });
                
                const blob = new Blob([text], {type: "text/plain"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `${filename}.txt`;
                a.click();
            }
        }

        // Add html2canvas for component export
        const script = document.createElement('script');
        script.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
        document.head.appendChild(script);

        /* ---------- INSIGHTS GENERATION ---------- */
        function generateInsights(s, biomarkerName) {
            const insights = [];
            
            // Distribution shape
            let shape = "normal";
            let shapeIcon = "fas fa-bell";
            let shapeColor = "var(--medical-green)";
            if (Math.abs(s.skew) > 0.5) {
                shape = s.skew > 0 ? "right-skewed" : "left-skewed";
                shapeIcon = "fas fa-chart-area";
                shapeColor = "var(--medical-purple)";
            }
            insights.push({
                icon: shapeIcon,
                color: shapeColor,
                label: "Distribution Shape",
                text: `The data shows a ${shape} distribution${shape !== "normal" ? ", indicating asymmetry in the variable values" : ""}.`,
                tooltip: "Distribution shape helps identify data patterns and potential biological significance."
            });
            
            // Variability
            let variability = "low";
            let varColor = "var(--medical-green)";
            if (s.cv > 0.3 && s.cv < 0.7) {
                variability = "moderate";
                varColor = "var(--medical-yellow)";
            } else if (s.cv >= 0.7) {
                variability = "high";
                varColor = "var(--medical-red)";
            }
            insights.push({
                icon: "fas fa-arrows-alt-v",
                color: varColor,
                label: "Data Variability",
                text: `This variable shows ${variability} variability (CV: ${s.cv.toFixed(2)}) across the patient population.`,
                tooltip: "Coefficient of variation indicates relative spread of data points."
            });
            
            // Outliers
            let outlierLevel = "none";
            let outlierIcon = "fas fa-check-circle";
            let outlierColor = "var(--medical-green)";
            if (s.outliers > 0 && s.outliers <= 3) {
                outlierLevel = "few";
                outlierIcon = "fas fa-exclamation-circle";
                outlierColor = "var(--medical-yellow)";
            } else if (s.outliers > 3) {
                outlierLevel = "many";
                outlierIcon = "fas fa-exclamation-triangle";
                outlierColor = "var(--medical-red)";
            }
            insights.push({
                icon: outlierIcon,
                color: outlierColor,
                label: "Outlier Detection",
                text: `${outlierLevel === "none" ? "No significant outliers detected" : `${s.outliers} outlier(s) detected`}, ${outlierLevel === "many" ? "which may indicate abnormal cases or measurement issues" : outlierLevel === "few" ? "worth investigating further" : "suggesting consistent measurements"}.`,
                tooltip: "Outliers are data points that fall outside the expected range."
            });
            
            return insights;
        }

        function renderInsights(insights) {
            const list = document.getElementById("insightsList");
            list.innerHTML = "";
            
            insights.forEach((insight, idx) => {
                setTimeout(() => {
                    const item = document.createElement("div");
                    item.className = "insight-item";
                    item.innerHTML = `
                        <i class="${insight.icon} insight-icon" style="color: ${insight.color};"></i>
                        <div class="insight-text">
                            <div class="insight-label">
                                ${insight.label}
                                <i class="fas fa-info-circle tooltip-icon" title="${insight.tooltip}"></i>
                            </div>
                            <div class="insight-description">${insight.text}</div>
                        </div>
                    `;
                    list.appendChild(item);
                }, idx * 200);
            });
        }

        /* ---------- ANALYSIS ---------- */
        document.getElementById("analyzeBtn").onclick = () => {
            if (comparisonMode) {
                if (selectedBiomarkers.length < 2) {
                    alert("Please select at least 2 variables for comparison");
                    return;
                }
                analyzeComparison();
            } else {
                if (!selected) return;
                analyzeSingle();
            }
        };

        function analyzeSingle() {
            currentValues = dataset.map(d => d[selected]).filter(v => !isNaN(v));
            const s = stats(currentValues);

            document.getElementById("analysisTitle").innerHTML = `<i class="fas fa-dna"></i> ${selected}`;
            document.getElementById("analysisSubtitle").textContent = `${currentValues.length} observations analyzed`;
            
            // Show patient data viewer
            document.getElementById("patientDataViewer").style.display = 'block';
            document.getElementById("patientNumber").max = dataset.length;
            document.getElementById("patientResult").style.display = 'none';
            
            // Create stat cards with export buttons
            document.getElementById("statsGrid").innerHTML = `
                <div class="stat-card">
                    <button class="export-btn" title="Export Mean" onclick="exportStat('mean', ${s.mean.toFixed(3)})">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-calculator" style="color: var(--accent-blue);"></i>
                    Mean<br><strong>${s.mean.toFixed(3)}</strong>
                </div>
                <div class="stat-card">
                    <button class="export-btn" title="Export Median" onclick="exportStat('median', ${s.median.toFixed(3)})">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-chart-area" style="color: var(--medical-teal);"></i>
                    Median<br><strong>${s.median.toFixed(3)}</strong>
                </div>
                <div class="stat-card">
                    <button class="export-btn" title="Export Std Dev" onclick="exportStat('std_dev', ${s.sd.toFixed(3)})">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-ruler" style="color: var(--medical-green);"></i>
                    Std Dev<br><strong>${s.sd.toFixed(3)}</strong>
                </div>
                <div class="stat-card">
                    <button class="export-btn" title="Export Variance" onclick="exportStat('variance', ${s.variance.toFixed(3)})">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-expand-alt" style="color: var(--medical-purple);"></i>
                    Variance<br><strong>${s.variance.toFixed(3)}</strong>
                </div>
                <div class="stat-card">
                    <button class="export-btn" title="Export Quartiles" onclick="exportStat('quartiles', 'Q1: ${s.q1.toFixed(2)}, Q3: ${s.q3.toFixed(2)}')">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-chart-pie" style="color: var(--medical-red);"></i>
                    Q1 / Q3<br><strong>${s.q1.toFixed(2)} / ${s.q3.toFixed(2)}</strong>
                </div>
                <div class="stat-card">
                    <button class="export-btn" title="Export IQR" onclick="exportStat('iqr', ${s.iqr.toFixed(3)})">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-arrows-alt-h" style="color: #ed8936;"></i>
                    IQR<br><strong>${s.iqr.toFixed(3)}</strong>
                </div>
                <div class="stat-card">
                    <button class="export-btn" title="Export Skewness" onclick="exportStat('skewness', ${s.skew.toFixed(3)})">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-balance-scale" style="color: #9f7aea;"></i>
                    Skewness<br><strong>${s.skew.toFixed(3)}</strong>
                </div>
                <div class="stat-card">
                    <button class="export-btn" title="Export Outliers" onclick="exportStat('outliers', ${s.outliers})">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-exclamation-triangle" style="color: #f56565;"></i>
                    Outliers<br><strong>${s.outliers}</strong>
                </div>
                <div class="stat-card">
                    <button class="export-btn" title="Export Range" onclick="exportStat('range', ${s.range.toFixed(3)})">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-arrows-left-right" style="color: #38a169;"></i>
                    Range<br><strong>${s.range.toFixed(3)}</strong>
                </div>
            `;

            // Generate and render insights
            const insights = generateInsights(s, selected);
            renderInsights(insights);

            if (chart) chart.destroy();
            const ctx = document.getElementById("distChart").getContext('2d');
            chart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: currentValues.map((_, i) => i + 1),
                    datasets: [{
                        label: selected,
                        data: currentValues,
                        borderColor: 'rgba(66, 153, 225, 0.8)',
                        backgroundColor: 'rgba(66, 153, 225, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.2,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Patient ${context.dataIndex + 1}: ${context.parsed.y.toFixed(3)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });

            showView("analysisView");
        }

        // Helper function for exporting individual stats
        function exportStat(statName, value) {
            let text = `BIOSTAT STATISTIC\n`;
            text += `============================================\n\n`;
            text += `Variable: ${selected}\n`;
            text += `Statistic: ${statName}\n`;
            text += `Value: ${value}\n`;
            text += `Generated: ${new Date().toLocaleString()}\n`;
            
            const blob = new Blob([text], {type: "text/plain"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${selected}_${statName}.txt`;
            a.click();
        }

        function analyzeComparison() {
            const colors = ['rgba(66, 153, 225, 0.8)', 'rgba(72, 187, 120, 0.8)', 'rgba(159, 122, 234, 0.8)'];
            
            document.getElementById("comparisonSubtitle").textContent = 
                `Comparing ${selectedBiomarkers.length} variables across ${dataset.length} patients`;

            // Bar chart comparison
            if (chart) chart.destroy();
            const barCtx = document.getElementById("comparisonBarChart").getContext('2d');
            const barDatasets = selectedBiomarkers.map((b, idx) => {
                const values = dataset.map(d => d[b]).filter(v => !isNaN(v));
                const s = stats(values);
                return {
                    label: b,
                    data: [s.mean, s.median, s.sd, s.max],
                    backgroundColor: colors[idx],
                    borderColor: colors[idx].replace('0.8', '1'),
                    borderWidth: 2
                };
            });

            chart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['Mean', 'Median', 'Std Dev', 'Max'],
                    datasets: barDatasets
                },
                options: {
                    responsive: true,
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });

            // Scatter plot (only for 2 variables)
            if (selectedBiomarkers.length === 2) {
                const values1 = dataset.map(d => d[selectedBiomarkers[0]]).filter(v => !isNaN(v));
                const values2 = dataset.map(d => d[selectedBiomarkers[1]]).filter(v => !isNaN(v));
                const correlation = calculateCorrelation(values1, values2);

                const scatterData = values1.map((v, i) => ({ x: v, y: values2[i] }));
                
                const scatterCtx = document.getElementById("scatterChart").getContext('2d');
                new Chart(scatterCtx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: `${selectedBiomarkers[0]} vs ${selectedBiomarkers[1]}`,
                            data: scatterData,
                            backgroundColor: 'rgba(66, 153, 225, 0.6)',
                            borderColor: 'rgba(66, 153, 225, 1)',
                            pointRadius: 5,
                            pointHoverRadius: 8
                        }]
                },
                    options: {
                        responsive: true,
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart'
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${selectedBiomarkers[0]}: ${context.parsed.x.toFixed(3)}, ${selectedBiomarkers[1]}: ${context.parsed.y.toFixed(3)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: selectedBiomarkers[0],
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: selectedBiomarkers[1],
                                    font: {
                                        size: 14,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        }
                    }
                });

                // Update correlation info
                document.getElementById("correlationValue").textContent = `r = ${correlation.toFixed(3)}`;
                
                const absCorr = Math.abs(correlation);
                let strength = "Weak";
                let badgeClass = "weak";
                if (absCorr >= 0.7) {
                    strength = "Strong";
                    badgeClass = "strong";
                } else if (absCorr >= 0.4) {
                    strength = "Moderate";
                    badgeClass = "moderate";
                }
                
                document.getElementById("correlationBadge").textContent = `${strength} Correlation`;
                document.getElementById("correlationBadge").className = `correlation-badge ${badgeClass}`;
            } else {
                document.getElementById("scatterChart").parentElement.style.display = 'none';
                document.getElementById("correlationInfo").innerHTML = `
                    <p style="text-align: center; color: var(--text-light);">
                        <i class="fas fa-info-circle"></i> 
                        Correlation analysis is available when exactly 2 variables are selected
                    </p>
                `;
            }

            showView("comparisonView");
        }

        /* ---------- RISK SCORE ---------- */
        document.getElementById("riskScoreBtn").onclick = () => {
            if (selectedBiomarkers.length === 0) {
                alert("Please select variables for risk score calculation");
                return;
            }

            calculateRiskScore();
        };

        function calculateRiskScore() {
            document.getElementById("riskSubtitle").textContent = 
                `Composite score based on ${selectedBiomarkers.length} selected variable(s)`;

            // Normalize and calculate composite score
            const normalizedScores = selectedBiomarkers.map(b => {
                const values = dataset.map(d => d[b]).filter(v => !isNaN(v));
                const s = stats(values);
                const patientValues = dataset.map(d => d[b]);
                const avgValue = patientValues.reduce((a, v) => a + (isNaN(v) ? 0 : v), 0) / patientValues.length;
                
                // Normalize to 0-100 scale
                const normalized = ((avgValue - s.min) / (s.max - s.min)) * 100;
                return {
                    variable: b,
                    score: normalized,
                    contribution: normalized
                };
            });

            const totalScore = normalizedScores.reduce((sum, item) => sum + item.score, 0) / normalizedScores.length;

            // Animate gauge
            setTimeout(() => {
                const needle = document.getElementById("gaugeNeedle");
                const rotation = -90 + (totalScore / 100) * 180;
                needle.style.transform = `translateX(-50%) rotate(${rotation}deg)`;
                
                document.getElementById("gaugeValue").textContent = totalScore.toFixed(0);
                
                let riskLevel = "low";
                let riskClass = "low";
                if (totalScore >= 33 && totalScore < 66) {
                    riskLevel = "moderate";
                    riskClass = "moderate";
                } else if (totalScore >= 66) {
                    riskLevel = "high";
                    riskClass = "high";
                }
                
                const riskLevelEl = document.getElementById("riskLevel");
                riskLevelEl.textContent = `${riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1)} Risk`;
                riskLevelEl.className = `risk-level ${riskClass}`;
            }, 300);

            // Render contributing factors
            const factorsList = document.getElementById("factorsList");
            factorsList.innerHTML = "";
            normalizedScores.forEach((item, idx) => {
                setTimeout(() => {
                    const factor = document.createElement("div");
                    factor.className = "factor-item";
                    factor.innerHTML = `
                        <span style="font-weight: 600; min-width: 120px;">${item.variable}</span>
                        <div class="factor-bar-container">
                            <div class="factor-bar" style="width: 0%"></div>
                        </div>
                        <span style="font-weight: 600; color: var(--primary-blue);">${item.contribution.toFixed(0)}</span>
                    `;
                    factorsList.appendChild(factor);
                    
                    setTimeout(() => {
                        factor.querySelector('.factor-bar').style.width = `${item.contribution}%`;
                    }, 100);
                }, idx * 150);
            });

            showView("riskScoreView");
        }

        /* ---------- SUMMARY ---------- */
        document.getElementById("summaryBtn").onclick = () => {
            const totalDataPoints = dataset.length * variables.length;
            const missingValues = calculateMissingValues();
            const completeRows = dataset.filter(row => {
                return variables.every(b => !isNaN(row[b]) && row[b] !== null);
            }).length;
            
            document.getElementById("summaryStats").innerHTML = `
                <div class="stat-card">
                    <i class="fas fa-user-friends" style="color: var(--accent-blue); font-size: 24px;"></i>
                    Patients<br><strong>${dataset.length}</strong>
                </div>
                <div class="stat-card">
                    <i class="fas fa-dna" style="color: var(--medical-teal); font-size: 24px;"></i>
                    Variables<br><strong>${variables.length}</strong>
                </div>
                <div class="stat-card">
                    <i class="fas fa-database" style="color: var(--medical-green); font-size: 24px;"></i>
                    Total Values<br><strong>${totalDataPoints.toLocaleString()}</strong>
                </div>
                <div class="stat-card">
                    <i class="fas fa-exclamation-circle" style="color: var(--medical-red); font-size: 24px;"></i>
                    Missing Values<br><strong>${missingValues}</strong>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-double" style="color: var(--medical-purple); font-size: 24px;"></i>
                    Complete Rows<br><strong>${completeRows}</strong>
                </div>
                <div class="stat-card">
                    <i class="fas fa-check-circle" style="color: #0bc5ea; font-size: 24px;"></i>
                    Data Quality<br><strong>${((1 - missingValues/totalDataPoints) * 100).toFixed(1)}%</strong>
                </div>
            `;
            
            showView("summaryView");
        };

        function calculateMissingValues() {
            let missing = 0;
            dataset.forEach(row => {
                variables.forEach(b => {
                    if (isNaN(row[b]) || row[b] === null || row[b] === undefined) {
                        missing++;
                    }
                });
            });
            return missing;
        }

        /* ---------- SAVE ---------- */
        document.getElementById("saveBtn").onclick = () => {
            if (!selected) {
                alert("Please analyze a variable first");
                return;
            }
    
            const title = document.getElementById("analysisTitle").textContent;
            const subtitle = document.getElementById("analysisSubtitle").textContent;
            let text = `BIOSTAT ANALYSIS REPORT\n`;
            text += `============================================\n\n`;
            text += `Variable: ${selected}\n`;
            text += `Observations: ${currentValues.length}\n`;
            text += `Generated: ${new Date().toLocaleString()}\n\n`;

    // Get statistical metrics directly from the stats object
            if (currentValues && currentValues.length > 0) {
                const s = stats(currentValues);
                text += `STATISTICAL SUMMARY:\n`;
                text += `-------------------\n`;
                text += `Mean: ${s.mean.toFixed(3)}\n`;
                text += `Median: ${s.median.toFixed(3)}\n`;
                text += `Standard Deviation: ${s.sd.toFixed(3)}\n`;
                text += `Variance: ${s.variance.toFixed(3)}\n`;
                text += `Minimum: ${s.min.toFixed(3)}\n`;
                text += `Maximum: ${s.max.toFixed(3)}\n`;
                text += `Range: ${s.range.toFixed(3)}\n`;
                text += `Q1 (25th percentile): ${s.q1.toFixed(3)}\n`;
                text += `Q3 (75th percentile): ${s.q3.toFixed(3)}\n`;
                text += `Interquartile Range (IQR): ${s.iqr.toFixed(3)}\n`;
                text += `Skewness: ${s.skew.toFixed(3)}\n`;
                text += `Coefficient of Variation: ${s.cv.toFixed(3)}\n`;
                text += `Outliers detected: ${s.outliers}\n`;
                text += `Sample Size: ${s.count}\n\n`;
            }

            text += `DATA INSIGHTS:\n`;
            text += `-------------\n`;
            const insights = document.querySelectorAll('#insightsList .insight-item');
            if (insights.length > 0) {
                insights.forEach(insight => {
                    const label = insight.querySelector('.insight-label').textContent.replace(/\s+/g, ' ').trim();
                    const desc = insight.querySelector('.insight-description').textContent;
                    text += `${label}: ${desc}\n\n`;
        });
    } else {
                text += `No insights available. Please run the analysis again.\n\n`;
    }

            const blob = new Blob([text], {type: "text/plain"});
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `${selected.replace(/\s+/g, '_')}_full_report_${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);

            const saveBtn = document.getElementById("saveBtn");
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Exported!';
            saveBtn.style.background = 'linear-gradient(135deg, #38a169 0%, #2f855a 100%)';
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.background = 'linear-gradient(135deg, var(--medical-green) 0%, #38a169 100%)';
    }, 2000);
};

        /* ---------- VIEW ---------- */
        function showView(id) {
            document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
            document.getElementById(id).classList.add("active");
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>